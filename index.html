<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>bars</title>
        <script type="text/javascript" src="d3/d3.js"></script>
        <style>

        body {
            margin: auto;
            width: 960px;
        }

        svg {
            font: 10px sans-serif;
        }

        .axis path,        
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        </style>
    </head>
    <body>

        <script type="text/javascript">

            var numberOfPumps = 3;

            // Dimensions
            var margin = {right: 100, bottom: 20, left: 50, top: 20};
            var w = 700 - margin.left - margin.right; // width  550
            var h = 300 - margin.bottom - margin.top; // height 260

            // Scales
            var x = d3.time.scale()
                .range([0, w]);

            var y = d3.scale.linear()
                .domain([1, 2, 3]) 
                .range([0, h/numberOfPumps, (2*h)/numberOfPumps]);

            var colors = d3.scale.ordinal()
                .domain([0, 1])
                .range(["rgb(224, 224, 224)","rgb(0, 204, 102)"]);

            // Axes
            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .ticks(2);
        
            // Containers
            var svg = d3.select("body").append("svg")
                .attr("width", w + margin.left + margin.right)   // width  700
                .attr("height", h + margin.bottom + margin.top)  // height 300
              .append("g")
                .attr("transform", "translate(" + margin.left + ", " + margin.top + ")"); // (0,0) -> (50,20)

            var groups = svg.selectAll("g");

            function createBlocks(pumpNumber) {

                d3.csv("pump" + pumpNumber.toString() + ".csv", function(error, dataset) {

                    var statusBlocks = [];
                    var thisStatusBlock = {startTime: dataset[0].time * 1000, pumpStatus: dataset[0].value};
                    statusBlocks.push(thisStatusBlock);

                    dataset.forEach(function (d) {
                        d.time = +d.time;
                        d.time *= 1000;
                        if (d.value != thisStatusBlock.pumpStatus) {
                            thisStatusBlock.duration = d.time - thisStatusBlock.startTime;
                            // new status. new object
                            var newStatusBlock = {};
                            newStatusBlock.pumpStatus = d.value;
                            newStatusBlock.startTime = d.time;
                            // add the new status block to the array of status blocks
                            statusBlocks.push(newStatusBlock);
                            // reset
                            thisStatusBlock = newStatusBlock;
                        }
                    });

                    thisStatusBlock.duration = dataset[dataset.length - 1].time - thisStatusBlock.startTime;
                    statusBlocks.push(thisStatusBlock);

                    console.log(statusBlocks);

                    renderBars(pumpNumber, statusBlocks);
                });
            }

            function renderBars(pumpNumber, statusBlocks) {

                x.domain([statusBlocks[0].startTime, statusBlocks[statusBlocks.length - 1].startTime + statusBlocks[statusBlocks.length - 1].duration]);
                //[100000, 500000]

                console.log(statusBlocks[statusBlocks.length - 1].startTime + statusBlocks[statusBlocks.length - 1].duration );

                // a group for each row of data
                var g = groups.data(statusBlocks)
                        .enter().append("g");

                // Add a rect for each block
                g.selectAll("rect")
                    .data(statusBlocks)
                .enter().append("rect")
                    .attr("x", function(d) { return x(d.startTime); })
                    .attr("y", y(pumpNumber))
                    .attr("width", function(d) { return x(d.startTime + d.duration) - x(d.startTime); })
                    .attr("height", h/numberOfPumps)
                    .style("fill", function(d) { return colors(d.pumpStatus); });
            }

            for (var i=0; i<numberOfPumps; i++) {
                createBlocks(i+1);
            }

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0, " + h + ")")
                .call(xAxis);  

            svg.append("g")
                .attr("class", "axis")
                .call(yAxis);

        </script>
    </body>
</html>